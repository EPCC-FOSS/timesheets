name: Build Windows Binary
on:
  push:
    branches:
      - 'version*'

jobs:
  build:
    name: Build for Windows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      # FIX: Install fyne-cross tool (it is not a GitHub Action)
      - name: Install Fyne-Cross
        run: go install github.com/fyne-io/fyne-cross@latest

      # FIX: Run fyne-cross as a command. 
      # It uses Docker (pre-installed on ubuntu-latest) to cross-compile.
      - name: Build for Windows
        run: |
          export PATH=$(go env GOPATH)/bin:$PATH
          fyne-cross windows -arch=amd64

      - name: Move and Rename Output Binary
        shell: bash
        run: |
          mkdir -p bins/win
          
          # Extract version from branch name (e.g., version1.0.5 -> 1.0.5)
          RAW_BRANCH="${{ github.ref_name }}"
          VERSION="${RAW_BRANCH#version}"
          
          echo "Detected Version: $VERSION"

          # fyne-cross outputs to 'fyne-cross/bin/windows-amd64'
          # We search for any .exe file in that folder
          SOURCE_EXE=$(find fyne-cross/bin/windows-amd64 -name "*.exe" | head -n 1)

          if [ -f "$SOURCE_EXE" ]; then
             TARGET="bins/win/calendar_${VERSION}.exe"
             mv "$SOURCE_EXE" "$TARGET"
             echo "✅ Success: Moved binary to $TARGET"
          else
             echo "❌ Error: No .exe file found in fyne-cross output!"
             exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: calendar-windows-${{ github.ref_name }}
          path: bins/win/calendar_*.exe
          retention-days: 10