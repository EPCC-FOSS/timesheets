name: Build macOS Binary

on:
  push:
    tags:
      - "v*"
    branches:
      - 'version*'

permissions:
  contents: write

jobs:
  build:
    name: Build for macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      # FIX 1: Install the new, non-deprecated Fyne tool
      - name: Install Fyne CLI
        run: go install fyne.io/tools/cmd/fyne@latest

      - name: Build macOS App
        run: |
          export CGO_ENABLED=1
          
          # FIX 2: Ensure Icon.png exists in your repo! 
          # If this step fails, it means you haven't pushed 'Icon.png' to GitHub.
          # We use the new tool path here.
          $(go env GOPATH)/bin/fyne package -os darwin -icon Icon.png

      - name: Move and Rename Output Binary
        shell: bash
        run: |
          mkdir -p bins/mac
          RAW_BRANCH="${{ github.ref_name }}"
          VERSION="${RAW_BRANCH#version}"
          
          # Find the .app folder
          SOURCE_APP=$(find . -maxdepth 1 -name "*.app" | head -n 1)

          if [ -d "$SOURCE_APP" ]; then
            APP_NAME="calendar_${VERSION}.app"
            TARGET_DIR="bins/mac"
            
            # Move it to bins/mac/calendar_1.0.app
            mv "$SOURCE_APP" "$TARGET_DIR/$APP_NAME"
            
            # FIX 3: ZIP THE APP. GitHub Releases cannot accept raw .app folders.
            cd "$TARGET_DIR"
            zip -r "calendar_${VERSION}_mac.zip" "$APP_NAME"
            
            echo "✅ Zipped app to bins/mac/calendar_${VERSION}_mac.zip"
          else
            echo "❌ Error: No .app bundle found!"
            exit 1
          fi

      # Upload the ZIP to Artifacts (not the .app folder)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: calendar-macos-${{ github.ref_name }}
          path: bins/mac/*.zip
          retention-days: 10
      
      # Upload the ZIP to Releases
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || startsWith(github.ref, 'refs/heads/version')
        with:
          tag_name: ${{ github.ref_name }}
          files: bins/mac/*.zip  # <--- MUST be the .zip file
          draft: false
          prerelease: false