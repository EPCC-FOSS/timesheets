name: Build macOS Binary

on:
    push:
        branches:
            - 'version*'

jobs:
    build:
        name: Build for macOS
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version: 'stable'

            # Install fyne-cross tool
            - name: Install Fyne-Cross
              run: go install github.com/fyne-io/fyne-cross@latest

            # Run fyne-cross as a command
            - name: Build for macOS
              run: |
                export PATH=$(go env GOPATH)/bin:$PATH
                fyne-cross darwin -arch=amd64

            - name: Move and Rename Output Binary
              shell: bash
              run: |
                mkdir -p bins/mac
                
                # Extract version from branch name (e.g., version1.0.5 -> 1.0.5)
                RAW_BRANCH="${{ github.ref_name }}"
                VERSION="${RAW_BRANCH#version}"
                
                echo "Detected Version: $VERSION"

                # fyne-cross outputs to 'fyne-cross/bin/darwin-amd64'
                # We search for any .app or archive file in that folder
                SOURCE_APP=$(find fyne-cross/bin/darwin-amd64 -name "*.app" -o -name "*.tar.xz" | head -n 1)

                if [ -f "$SOURCE_APP" ] || [ -d "$SOURCE_APP" ]; then
                        TARGET="bins/mac/calendar_${VERSION}.app"
                        mv "$SOURCE_APP" "$TARGET"
                        echo "✅ Success: Moved binary to $TARGET"
                else
                        echo "❌ Error: No .app or archive found in fyne-cross output!"
                        exit 1
                fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: calendar-macos-${{ github.ref_name }}
                path: bins/mac/calendar_*
                retention-days: 10