name: Build Linux Binary

on:
    push:
        branches:
            - 'version*'

jobs:
    build:
        name: Build for Linux
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version: 'stable'

            # Install fyne-cross tool
            - name: Install Fyne-Cross
              run: go install github.com/fyne-io/fyne-cross@latest

            # Run fyne-cross as a command
            - name: Build for Linux
              run: |
                export PATH=$(go env GOPATH)/bin:$PATH
                fyne-cross linux -arch=amd64

            - name: Move and Rename Output Binary
              shell: bash
              run: |
                mkdir -p bins/linux
                
                # Extract version from branch name (e.g., version1.0.5 -> 1.0.5)
                RAW_BRANCH="${{ github.ref_name }}"
                VERSION="${RAW_BRANCH#version}"
                
                echo "Detected Version: $VERSION"

                # fyne-cross outputs to 'fyne-cross/bin/linux-amd64'
                # We search for any executable file in that folder
                SOURCE_BIN=$(find fyne-cross/bin/linux-amd64 -type f -executable | head -n 1)

                if [ -f "$SOURCE_BIN" ]; then
                        TARGET="bins/linux/calendar_${VERSION}"
                        mv "$SOURCE_BIN" "$TARGET"
                        echo "✅ Success: Moved binary to $TARGET"
                else
                        echo "❌ Error: No executable file found in fyne-cross output!"
                        exit 1
                fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: calendar-linux-${{ github.ref_name }}
                path: bins/linux/calendar_*
                retention-days: 10